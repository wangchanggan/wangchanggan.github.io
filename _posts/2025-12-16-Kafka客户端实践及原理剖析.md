---
layout:     post
title:      Kafka客户端实践及原理剖析
date:       2025-12-16
catalog: true
tags:
    - 消息队列
---

# 生产者消息分区机制原理
## 分区
分区的作用就是提供负载均衡的能力，实现系统的高伸缩性（Scalability）。不同的分区能够被放置到不同节点的机器上，而数据的读写操作也都是针对分区这个粒度而进行的，每个节点的机器都能独立地执行各自分区的读写请求处理。并且，还可以通过添加新的节点机器来增加整体系统的吞吐量。

### 分区策略
所谓分区策略是决定生产者将消息发送到哪个分区的算法。Kafka 提供了默认的分区策略，同时它也支持自定义分区策略。

#### 轮询策略
轮询策略有非常优秀的负载均衡表现，它总是能保证消息最大限度地被平均分配到所有分区上，故默认情况下它是最合理的分区策略，也是最常用的分区策略之一。

#### 按消息键保序策略
Kafka 允许为每条消息定义消息键，简称为 Key。这个 Key 是一个有着明确业务含义的字符串，比如客户代码、部门编号或是业务 ID 等；也可以用来表征消息元数据。特别是在 Kafka 不支持时间戳的年代，在一些场景中，工程师们都是直接将消息创建时间封装进 Key 里面的。一旦消息被定义了 Key，就可以保证同一个 Key 的所有消息都进入到相同的分区里面，由于每个分区下的消息处理都是有顺序的，故被称为按消息键保序策略。



# 生产者压缩算法
## 怎么压缩
Kafka 的消息层次都分为两层：消息集合（message set）以及消息（message）。一个消息集合中包含若干条日志项（record item），而日志项才是真正封装消息的地方。Kafka 底层的消息日志由一系列消息集合日志项组成。Kafka 通常不会直接操作具体的一条条消息，它总是在消息集合这个层面上进行写入操作。

1. 把消息的公共部分抽取出来放到外层消息集合里面，不用每条消息都保存这些信息。
2. 对整个消息集合进行压缩。

## 何时压缩
在 Kafka 中，压缩可能发生在两个地方：生产者端和 Broker 端。

生产者程序中配置 compression.type 参数即表示启用指定类型的压缩算法。

大部分情况下 Broker 从 Producer 端接收到消息后仅仅是原封不动地保存而不会对其进行任何修改，但有两种例外情况就可能让 Broker 重新压缩消息。

1. Broker 端指定了和 Producer 端不同的压缩算法。
2. Broker 端发生了消息格式转换。所谓的消息格式转换主要是为了兼容老版本的消费者程序。除了压缩之外，还丧失了引以为豪的 Zero Copy 特性。

## 何时解压缩

解压缩发生在消费者程序中，Producer 发送压缩消息到 Broker 后，Broker 照单全收并原样保存起来。当 Consumer 程序请求这部分消息时，Broker 依然原样发送出去，当消息到达 Consumer 端后，由 Consumer 自行解压缩还原成之前的消息。

Kafka 会将启用了哪种压缩算法封装进消息集合中，当 Consumer 读取到消息集合时，它自然就知道了这些消息使用的是哪种压缩算法。

Producer 端压缩、Broker 端保持、Consumer 端解压缩。

除了在 Consumer 端解压缩，Broker 端也会进行解压缩。注：这和前面提到消息格式转换时发生的解压缩是不同的场景。每个压缩过的消息集合在 Broker 端写入时都要发生解压缩操作，目的就是为了对消息执行各种验证。这种解压缩对 Broker 端性能是有一定影响的，特别是对 CPU 的使用率而言。

## 各种压缩算法对比
两个重要的指标：
1. 压缩比
2. 压缩 / 解压缩吞吐量

![](/img/in-post/MQ/Kafka/comparison-of-compression-algorithms.png)

* 在吞吐量方面：LZ4 > Snappy > zstd 和 GZIP；
* 在压缩比方面，zstd > LZ4 > GZIP > Snappy。
* 物理资源，使用 Snappy 算法占用的网络带宽最多，zstd 最少，提供超高的压缩比；
* CPU 使用率，各个算法表现得差不多，只是在压缩时 Snappy 算法使用的 CPU 较多一些，而在解压缩时 GZIP 算法则可能使用更多的 CPU。

## 最佳实践
* 启用压缩的一个条件就是 Producer 程序运行机器上的 CPU 资源要很充足。
* 如果带宽资源有限，建议开启压缩。如果客户端机器 CPU 资源有很多富余，强烈建议开启 zstd 压缩。
* 对不可抗拒的解压缩无能为力，但至少能规避掉那些意料之外的解压缩。有条件的话尽量保证不要出现消息格式转换的情况。



